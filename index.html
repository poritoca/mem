<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>闇の影響関係図（多層増殖 v3）</title>
<style>
  :root{
    --bg:#0b0c10;
    --panel:#13141a;
    --ink:#e9e9ee;
    --muted:#b9b9c5;
    --accent:#8a7cff;   /* 妖しい紫（上層ミクロ群） */
    --evil:#ff4d7a;
    --faction:#cfe6ff;  /* dokudenpa 群 */
  }
  @font-face{
    font-family: "Noto Sans JP";
    src: local("Noto Sans JP"), local("Yu Gothic Medium");
    font-display: swap;
  }
  html,body{
    margin:0; padding:0; height:100%;
    background: radial-gradient(120% 100% at 50% 0%, #10111a 0%, #0a0b10 60%, #06070c 100%);
    color: var(--ink);
    font-family: "Noto Sans JP", system-ui, -apple-system, "Hiragino Kaku Gothic ProN",
      "Yu Gothic", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
    letter-spacing:.03em;
  }
  .fx-vignette::before{
    content:""; position:fixed; inset:-10vmin; pointer-events:none; z-index:2;
    background:radial-gradient(120% 140% at 50% 50%, transparent 55%, rgba(0,0,0,.45) 80%, rgba(0,0,0,.78) 100%);
    mix-blend-mode:multiply;
  }
  .fx-noise::after{
    content:""; position:fixed; inset:-10vmin; z-index:3; pointer-events:none;
    opacity:.08;
    background-image:url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width=\"200\" height=\"200\" viewBox=\"0 0 200 200\">\
<filter id=\"n\"><feTurbulence type=\"fractalNoise\" baseFrequency=\"0.8\" numOctaves=\"2\" stitchTiles=\"stitch\"/></filter>\
<rect width=\"100%\" height=\"100%\" filter=\"url(%23n)\"/></svg>');
    animation: grain 1.5s steps(2) infinite;
    mix-blend-mode:soft-light;
  }
  @keyframes grain { from{ transform:translate(0,0) } to{ transform:translate(1%, -1%) } }
  .fog, .fog::before, .fog::after{
    position: fixed; inset:-20vmin; content:""; pointer-events:none; z-index:1;
    background: radial-gradient(40vmin 30vmin at 20% 20%, rgba(112,105,170,.07), transparent 60%),
                radial-gradient(50vmin 35vmin at 80% 30%, rgba(255,80,150,.05), transparent 60%),
                radial-gradient(45vmin 30vmin at 60% 80%, rgba(90,200,255,.05), transparent 60%);
    filter: blur(30px);
    animation: drift 18s linear infinite;
  }
  .fog::before{ animation-duration: 26s; animation-direction: reverse; opacity:.7; }
  .fog::after{ animation-duration: 34s; opacity:.5; }
  @keyframes drift {
    from { transform: translate3d(-3%, -2%, 0) }
    50%  { transform: translate3d( 3%,  2%, 0) }
    to   { transform: translate3d(-3%, -2%, 0) }
  }
  header{ text-align:center; padding:1.2rem .8rem 0; z-index:4; position:relative; }
  h1{ margin:.2rem auto 0; font-weight:700; font-size: clamp(1.25rem, 1rem + 1.5vw, 2rem);
      letter-spacing:.08em; text-shadow: 0 0 .35rem rgba(255,255,255,.12), 0 0 1.2rem rgba(90,80,200,.35);}
  p.desc{ margin:.4rem auto 1.2rem; color:var(--muted); font-size:.92rem; }
  .stage{ position:relative; z-index:4; max-width:1200px; margin:0 auto; padding: 1rem 1rem 2rem; }

  .node rect{
    fill: var(--panel); stroke: rgba(180,180,240,.35); stroke-width: 1.2; rx: 10; ry: 10;
    filter: drop-shadow(0 2px 10px rgba(0,0,0,.45));
  }
  .node text{ font-size: 16px; fill: var(--ink); }
  .node.small text{ font-size: 14px; }
  .node .sub { fill: var(--muted); font-size: 12px; }
  .root rect{ stroke: var(--accent); }
  .root text{ font-weight: 800; letter-spacing:.06em }
  .evil rect{ stroke: rgba(255,77,122,.65); }
  .evil text{ fill: #ffd0dc; }
  .faction rect{ stroke: rgba(180,220,255,.55); }

  .link{ stroke: rgba(200,200,230,.42); stroke-width: 2; fill: none; marker-end: url(#arrow);
         filter: drop-shadow(0 0 .25rem rgba(0,0,0,.6)); }
  .link.evil{ stroke: rgba(255,77,122,.7) }
  .label{ fill: var(--muted); font-size: 12px; }

  svg{ width:100%; height:auto }

  .tip {
    position: fixed; left:0; top:0;
    transform: translate(-50%, -120%);
    background: rgba(16,16,22,.98);
    border: 1px solid rgba(138,124,255,.35);
    border-radius: .6rem;
    padding:.45rem .65rem; white-space: nowrap;
    font-size:.95rem; color:var(--ink);
    pointer-events:none; opacity:0; transition:.12s ease;
    box-shadow: 0 16px 32px rgba(0,0,0,.55);
    z-index: 10;
  }

  /* dokudenpa 群（青系・四角） */
  .swarm .slink{
    stroke: rgba(160,200,255,.32);
    stroke-width: 1.1;
    fill:none;
    marker-end:url(#arrowMini);
  }
  .swarm .mininode{
    fill: var(--faction);
    stroke: rgba(120,170,230,.75);
    stroke-width: .6;
    rx: 3; ry: 3;
    filter: drop-shadow(0 0 10px rgba(160,210,255,.45));
  }

  /* 上層ミクロ群（紫系・四角） */
  .micros .mlink{
    stroke: rgba(180,150,255,.28);
    stroke-width: 1;
    fill:none;
    marker-end:url(#arrowMini);
  }
  .micros .micro{
    fill: #b69cff;
    stroke: rgba(200,170,255,.75);
    stroke-width: .55;
    rx: 2.6; ry: 2.6;
    filter: drop-shadow(0 0 9px rgba(180,150,255,.45));
  }
</style>
</head>
<body>
<div class="fx-vignette fx-noise"></div>
<div class="fog"></div>

<header>
  <h1>闇の影響関係図</h1>
  <p class="desc">タップで注釈表示。dokudenpa は青い群勢、その他の上層も紫の微小ノードを少量“繁殖”。</p>
</header>

<main class="stage">
  <svg viewBox="0 0 1200 960" aria-labelledby="title desc" role="img">
    <title id="title">闇の影響関係図（多層増殖 v3）</title>
    <desc id="desc">トミさん起点の闇と、別勢力 dokudenpa の増殖に加え、上層ほど多い紫のミクロ群を可視化。</desc>

    <defs>
      <marker id="arrow" markerWidth="10" markerHeight="8" refX="8" refY="4" orient="auto">
        <path d="M0,0 L10,4 L0,8 Z" fill="rgba(220,220,255,.8)"></path>
      </marker>
      <marker id="arrowMini" markerWidth="8" markerHeight="6" refX="6" refY="3" orient="auto">
        <path d="M0,0 L8,3 L0,6 Z" fill="rgba(210,230,255,.75)"></path>
      </marker>
    </defs>

    <!-- 主要ノード -->
    <g id="tomi" class="node root tappable" data-tip="すべての闇の根源" transform="translate(480,40)">
      <rect width="240" height="72"></rect>
      <text x="120" y="36" text-anchor="middle" dominant-baseline="middle">トミさん</text>
    </g>

    <g id="knsk" class="node tappable" data-tip="二番手／拡散者。一説では師を超える" transform="translate(480,170)">
      <rect width="240" height="72"></rect>
      <text x="120" y="34" text-anchor="middle">knsk</text>
      <text class="sub" x="120" y="54" text-anchor="middle">拡散・媒介</text>
    </g>

    <g id="huyu" class="node evil tappable" data-tip="影の実力者。装いの下に桁違いの邪悪" transform="translate(780,320)">
      <rect width="240" height="72"></rect>
      <text x="120" y="34" text-anchor="middle">huyu</text>
      <text class="sub" x="120" y="54" text-anchor="middle">??? / 真の黒幕説</text>
    </g>

    <g id="capting" class="node small tappable" data-tip="元はまとも→悪影響で没入" transform="translate(180,320)">
      <rect width="240" height="72"></rect>
      <text x="120" y="34" text-anchor="middle">capting</text>
      <text class="sub" x="120" y="54" text-anchor="middle">闇にのめり込む</text>
    </g>

    <g id="hase" class="node small tappable" data-tip="かつてまとも→従順な配下へ" transform="translate(480,470)">
      <rect width="240" height="72"></rect>
      <text x="120" y="34" text-anchor="middle">hase</text>
      <text class="sub" x="120" y="54" text-anchor="middle">従順な配下</text>
    </g>

    <g id="anrak" class="node small tappable" data-tip="光の存在。闇の中で抵抗を続ける" transform="translate(820,470)">
      <rect width="200" height="72"></rect>
      <text x="100" y="34" text-anchor="middle">anrak</text>
      <text class="sub" x="100" y="54" text-anchor="middle">抵抗する光</text>
    </g>

    <g id="dokudenpa" class="node faction tappable" data-tip="特大勢力。SNS 内に多数の軍勢" transform="translate(380,730)">
      <rect width="440" height="80"></rect>
      <text x="220" y="40" text-anchor="middle">dokudenpa（別勢力）</text>
    </g>

    <!-- 主要リンク -->
    <path class="link evil" d="M600,112 C600,132 600,148 600,170" />
    <path class="link" d="M520,242 C430,290 340,300 300,320" />
    <path class="link evil" d="M680,242 C780,280 870,290 900,320" />
    <path class="link" d="M600,242 C600,340 600,380 600,470" />
    <path class="link" d="M640,242 C720,340 840,380 920,470" />
    <text class="label" x="612" y="150">邪悪なエネルギー</text>
    <text class="label" x="352" y="302">悪影響</text>
    <text class="label" x="742" y="300">装いの下で拡大</text>
    <text class="label" x="608" y="420">従属</text>
    <text class="label" x="888" y="420">抵抗</text>

    <!-- swarm containers -->
    <g id="swarm" class="swarm"></g>
    <g id="micros" class="micros"></g>

  </svg>
</main>

<div id="tooltip" class="tip" role="status" aria-live="polite"></div>

<script>
(function(){
  const svg = document.querySelector('svg');
  const tip = document.getElementById('tooltip');
  let tipVisible = false;

  // タップで表示/非表示
  svg.addEventListener('pointerdown', (e)=>{
    const node = e.target.closest('.tappable');
    if(node){
      showTip(node, e.clientX, e.clientY);
    } else if(tipVisible){
      hideTip();
    }
  });
  function showTip(el, x, y){
    tip.textContent = el.getAttribute('data-tip') || '';
    tip.style.left = x + 'px';
    tip.style.top  = (y - 16) + 'px';
    tip.style.opacity = 1;
    tipVisible = true;
  }
  function hideTip(){ tip.style.opacity = 0; tipVisible = false; }

  // ==== 位置取得（<g transform="translate(x,y)"> とサイズから中心を出す）
  function center(el, w, h){
    const tr = el.getAttribute('transform') || '';
    const m = tr.match(/translate\(([^,]+),\s*([^)]+)\)/);
    const tx = m ? parseFloat(m[1]) : 0;
    const ty = m ? parseFloat(m[2]) : 0;
    return { x: tx + w/2, y: ty + h/2 };
  }

  // ===== dokudenpa 増殖（青・四角） =====
  const swarmLayer = document.getElementById('swarm');
  const baseEl = document.getElementById('dokudenpa');
  const baseC = center(baseEl, 440, 80);

  let seed = 42;
  function rand(){ seed = (seed * 1664525 + 1013904223) % 0x100000000; return seed/0x100000000; }
  function rr(a,b){ return a + rand()*(b-a); }

  const dNodes = [];
  const MAX_D = 120;
  const SPAWN_D = 450;

  function makeDNode(x,y,parent,size){
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    const r = document.createElementNS('http://www.w3.org/2000/svg','rect');
    r.setAttribute('class','mininode');
    r.setAttribute('x', x-size/2); r.setAttribute('y', y-size/2);
    r.setAttribute('width', size);  r.setAttribute('height', size);
    r.setAttribute('rx', 3); r.setAttribute('ry', 3);
    g.appendChild(r);
    swarmLayer.appendChild(g);

    let path=null;
    if(parent){
      path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('class','slink');
      swarmLayer.insertBefore(path, g);
    }
    return {g, r, path, x, y, size,
            vx: rr(-.25,.25), vy: rr(-.25,.25),
            jitter: rr(.5,1.6), parent};
  }

  const root = makeDNode(baseC.x, baseC.y, null, 12);
  dNodes.push(root);

  const spD = setInterval(()=>{
    if(dNodes.length>=MAX_D){ clearInterval(spD); return; }
    const p = dNodes[Math.floor(rand()*dNodes.length)];
    const ang = rr(0, Math.PI*2), rad = rr(30, 90);
    const nx = p.x + Math.cos(ang)*rad;
    const ny = p.y + Math.sin(ang)*(rad*0.65);
    const child = makeDNode(nx, ny, p, rr(6,11));
    child.vx += (nx-baseC.x)*0.0008 + rr(-0.12,0.12);
    child.vy += (ny-baseC.y)*0.0006 + rr(-0.12,0.12);
    dNodes.push(child);
  }, SPAWN_D);

  // ===== 上層ミクロ群（紫・四角） =====
  const microLayer = document.getElementById('micros');
  function makeMicro(x,y,parent,size){
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    const r = document.createElementNS('http://www.w3.org/2000/svg','rect');
    r.setAttribute('class','micro');
    r.setAttribute('x', x-size/2); r.setAttribute('y', y-size/2);
    r.setAttribute('width', size);  r.setAttribute('height', size);
    r.setAttribute('rx', 2.6); r.setAttribute('ry', 2.6);
    g.appendChild(r);
    microLayer.appendChild(g);

    let path=null;
    if(parent){
      path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('class','mlink');
      microLayer.insertBefore(path, g);
    }
    return {g, r, path, x, y, size,
            vx: rr(-.22,.22), vy: rr(-.22,.22),
            jitter: rr(.4,1.2), parent};
  }

  // アンカー（上層ほど spawn 多）
  const anchors = [
    { id:'tomi',   w:240, h:72, weight: 1.0, max: 80,  interval: 900 },
    { id:'knsk',   w:240, h:72, weight: 0.6, max: 48,  interval: 1100 },
    { id:'huyu',   w:240, h:72, weight: 0.35, max: 28, interval: 1300 },
    { id:'capting',w:240, h:72, weight: 0.20, max: 18, interval: 1500 },
    { id:'hase',   w:240, h:72, weight: 0.18, max: 16, interval: 1600 },
    { id:'anrak',  w:200, h:72, weight: 0.14, max: 14, interval: 1700 }
  ].map(a=>{
    const el = document.getElementById(a.id);
    const c  = center(el, a.w, a.h);
    a.cx = c.x; a.cy = c.y; a.nodes=[];
    return a;
  });

  anchors.forEach(a=>{
    a.nodes.push(makeMicro(a.cx, a.cy, null, rr(5,9)));
    const timer = setInterval(()=>{
      if(a.nodes.length>=a.max){ clearInterval(timer); return; }
      if(rand() > a.weight) return;
      const p = a.nodes[Math.floor(rand()*a.nodes.length)];
      const ang = rr(0, Math.PI*2), rad = rr(18, 70);
      const nx  = p.x + Math.cos(ang)*rad;
      const ny  = p.y + Math.sin(ang)*(rad*0.6);
      const child = makeMicro(nx, ny, p, rr(4.5,8.5));
      child.vx += (nx - a.cx)*0.0007 + rr(-0.08,0.08);
      child.vy += (ny - a.cy)*0.0006 + rr(-0.08,0.08);
      a.nodes.push(child);
    }, a.interval);
  });

  // アニメーション（両群ともランダムウォーク）
  let last = performance.now();
  function step(t){
    const dt = Math.max(0.016, Math.min(0.05, (t - last)/1000));
    last = t;
    function advance(list, origin){
      for(const n of list){
        n.vx += (rand()-0.5) * 0.03 * n.jitter;
        n.vy += (rand()-0.5) * 0.03 * n.jitter;
        if(origin){
          n.vx += (n.x - origin.x) * 0.00005;
          n.vy += (n.y - origin.y) * 0.00005;
        }
        n.vx *= 0.985; n.vy *= 0.985;
        n.x += n.vx * (dt*60);
        n.y += n.vy * (dt*60);
        n.r.setAttribute('x', n.x - n.size/2);
        n.r.setAttribute('y', n.y - n.size/2);
        if(n.path){
          const px = n.parent ? n.parent.x : (origin? origin.x : n.x);
          const py = n.parent ? n.parent.y : (origin? origin.y : n.y);
          const cx = (px + n.x)/2 + rr(-18,18);
          const cy = (py + n.y)/2 + rr(-10,10);
          n.path.setAttribute('d', `M ${px},${py} Q ${cx},${cy} ${n.x},${n.y}`);
        }
      }
    }
    advance(dNodes, baseC);
    anchors.forEach(a=> advance(a.nodes, {x:a.cx, y:a.cy}));
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);

})();
</script>
</body>
</html>
